<UserControl
    x:Class="FreeAIr.UI.ToolWindows.ChatListToolWindowControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:imaging="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.Imaging"
    xmlns:theming="clr-namespace:Microsoft.VisualStudio.PlatformUI;assembly=Microsoft.VisualStudio.Imaging"
    xmlns:util="clr-namespace:Microsoft.VisualStudio.PlatformUI;assembly=Microsoft.VisualStudio.Utilities"
    xmlns:catalog="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.ImageCatalog"
    xmlns:toolkit="clr-namespace:Community.VisualStudio.Toolkit;assembly=Community.VisualStudio.Toolkit"
    xmlns:resources="clr-namespace:FreeAIr.Resources"
    xmlns:mdxaml="https://github.com/whistyun/MdXaml"
    xmlns:plugins="clr-namespace:MdXaml.Plugins;assembly=MdXaml.Plugins"
    toolkit:Themes.UseVsTheme="True"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="300"
    Name="ChatListToolWindow"
    >

    <Grid
        Margin="2"
        >
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="auto"/>
            <ColumnDefinition Width="4*"/>
        </Grid.ColumnDefinitions>

        <Grid
            Grid.Row="0"
            Grid.Column="0"
            Grid.ColumnSpan="3"
            HorizontalAlignment="Stretch"
            >
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="auto"/>
                <ColumnDefinition Width="auto"/>
                <ColumnDefinition Width="auto"/>
                <ColumnDefinition />
            </Grid.ColumnDefinitions>

            <Button
                Grid.Column="0"
                Margin="2"
                Content="{x:Static resources:Resources.UI_OpenInEditor}"
                x:Name="OpenAsMdButton"
                Command="{Binding OpenInEditorCommand}"
                />
            <Button
                Grid.Column="1"
                Margin="2"
                Content="{x:Static resources:Resources.UI_RemoveChat}"
                Command="{Binding RemoveCommand}"
                />
            <Button
                Grid.Column="2"
                Margin="2"
                Content="{x:Static resources:Resources.UI_StopWaiting}"
                Command="{Binding StopCommand}"
                />

            <Button
                Grid.Column="3"
                Margin="2"
                Content="{x:Static resources:Resources.UI_StartDiscussion}"
                HorizontalAlignment="Right"
                Command="{Binding StartDiscussionCommand}"
                />
        </Grid>

        <ListBox
            Grid.Row="1"
            Grid.Column="0"
            Margin="2"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            ItemsSource="{Binding Path=ChatList}"
            SelectedItem="{Binding Path=SelectedChat}"
            ScrollViewer.HorizontalScrollBarVisibility="Auto"
            ScrollViewer.VerticalScrollBarVisibility="Auto"
            >
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel
                        >
                        <StackPanel.InputBindings>
                            <MouseBinding Gesture="LeftDoubleClick" Command="{Binding ElementName=ChatListToolWindow, Path=DataContext.OpenInEditorCommand}"/>
                        </StackPanel.InputBindings>
                        <TextBlock
                            Text="{Binding Path=FirstRow, Mode=OneWay}"
                            />
                        <TextBlock
                            Text="{Binding Path=SecondRow, Mode=OneWay}"
                            />
                        <TextBlock
                            Text="{Binding Path=ThirdRow, Mode=OneWay}"
                            />
                        <TextBlock
                            Text="{Binding Path=FourthRow, Mode=OneWay}"
                            />
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <GridSplitter
            Grid.Row="1"
            Grid.Column="1"
            ResizeDirection="Columns"
            Width="2"
            VerticalAlignment="Stretch"
            HorizontalAlignment="Center"
            />

        <Grid
            Grid.Row="1"
            Grid.Column="2"
            >
            <Grid.RowDefinitions>
                <RowDefinition Height="10*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="3*" />
            </Grid.RowDefinitions>

            <mdxaml:MarkdownScrollViewer 
                Grid.Row="0"
                Margin="2"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalScrollBarVisibility="Auto"
                VerticalScrollBarVisibility="Auto"
                Markdown="{Binding Path=SelectedChatResponse, Mode=OneWay}"
                Name="AnswerControl"
                >
                <mdxaml:MarkdownScrollViewer.MarkdownStyle>
                    <Style TargetType="FlowDocument">
                        <Setter Property="FontFamily"	 Value="Calibri" />
                        <Setter Property="TextAlignment" Value="Left" />
                        <Setter Property="PagePadding"   Value="0"/>

                        <Style.Resources>
                            <Style TargetType="Section">
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="Blockquote">
                                        <Setter Property="Margin"          Value="0, 10, 0, 0"/>
                                        <Setter Property="Padding"         Value="10, 1, 0, 1"/>
                                        <Setter Property="BorderBrush"     Value="#FF000055"/>
                                        <Setter Property="BorderThickness" Value="15,1,1,1"/>
                                        <Setter Property="FontFamily"      Value="Cascadia Code"/>
                                        <Setter Property="FontSize"        Value="20"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>

                            <!-- here is a style for ```block``` -->
                            <Style TargetType="avalonEdit:TextEditor" xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit">
                                <Setter Property="Foreground"      Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}"/>
                                <Setter Property="Background"      Value="Transparent"/>
                                <Setter Property="FontFamily"      Value="Cascadia Code"/>
                                <Setter Property="FontSize"        Value="14"/>

                                <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
                                <Setter Property="VerticalScrollBarVisibility"   Value="Auto"/>
                                <Setter Property="Padding"                       Value="5,5,5,5"/>

                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="{x:Type avalonEdit:TextEditor}">

                                            <Grid
                                                Margin="0,5,0,0"
                                                >
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="auto" />
                                                    <RowDefinition />
                                                </Grid.RowDefinitions>

                                                <StackPanel
                                                    Grid.Row="0"
                                                    Orientation="Horizontal"
                                                    HorizontalAlignment="Right"
                                                    >
                                                    <Button
                                                        HorizontalAlignment="Right"
                                                        Margin="5,0,5,0"
                                                        Content="Copy"
                                                        Style="{Binding ElementName=OpenAsMdButton, Path=Style}"
                                                        Command="{Binding ElementName=ChatListToolWindow, Path=DataContext.CopyCodeBlockCommand}"
                                                        CommandParameter="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=TextArea}"
                                                        ToolTip="Copy this code part to clipboard"
                                                        />
                                                    <Button
                                                        HorizontalAlignment="Right"
                                                        Margin="5,0,5,0"
                                                        Content="Replace selected text"
                                                        Style="{Binding ElementName=OpenAsMdButton, Path=Style}"
                                                        Command="{Binding ElementName=ChatListToolWindow, Path=DataContext.ReplaceSelectedTextCommand}"
                                                        CommandParameter="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=TextArea}"
                                                        ToolTip="Replace the selected block of the code in the VS document with this code part"
                                                        />

                                                </StackPanel>

                                                <ScrollViewer
                                                    Grid.Row="1"
                                                    Focusable="False"
                                                    Name="PART_ScrollViewer"
                                                    CanContentScroll="True"
                                                    VerticalScrollBarVisibility="{TemplateBinding VerticalScrollBarVisibility}"
                                                    HorizontalScrollBarVisibility="{TemplateBinding HorizontalScrollBarVisibility}"
                                                    Content="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=TextArea}"
                                                    VerticalContentAlignment="Top"
                                                    HorizontalContentAlignment="Left"
                                                    Padding="{TemplateBinding Padding}"
                                                    />
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>

                            <Style TargetType="Paragraph">
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="Heading1">
                                        <Setter Property="FontSize"    Value="42" />
                                        <Setter Property="Foreground"  Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="FontWeight"  Value="Light" />
                                    </Trigger>

                                    <Trigger Property="Tag" Value="Heading2">
                                        <Setter Property="FontSize"    Value="36" />
                                        <Setter Property="Foreground"  Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="FontWeight"  Value="Light" />
                                    </Trigger>

                                    <Trigger Property="Tag" Value="Heading3">
                                        <Setter Property="FontSize"    Value="30" />
                                        <Setter Property="Foreground"  Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="FontWeight"  Value="Light" />
                                    </Trigger>

                                    <Trigger Property="Tag" Value="Heading4">
                                        <Setter Property="FontSize"    Value="24" />
                                        <Setter Property="Foreground"  Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="FontWeight"  Value="Light" />
                                    </Trigger>

                                    <Trigger Property="Tag" Value="CodeBlock">
                                        <Setter Property="FontFamily"      Value="Cascadia Code"/>
                                        <Setter Property="FontSize"        Value="14"/>
                                        <Setter Property="Foreground"  Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="Background"      Value="Transparent"/>
                                        <Setter Property="BorderBrush"     Value="#DEDEDE"/>
                                        <Setter Property="BorderThickness" Value="0,5,0,5"/>
                                        <Setter Property="Margin"          Value="5,0,5,0"/>
                                    </Trigger>

                                    <Trigger Property="Tag" Value="Note">
                                        <Setter Property="Margin"          Value="5,0,5,0"/>
                                        <Setter Property="Padding"         Value="10, 5"/>
                                        <Setter Property="BorderBrush"     Value="#DEDEDE"/>
                                        <Setter Property="BorderThickness" Value="3,3,3,3"/>
                                        <Setter Property="Background"      Value="Transparent"/>
                                    </Trigger>

                                </Style.Triggers>
                            </Style>

                            <Style TargetType="Run">
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="CodeSpan">
                                        <Setter Property="FontFamily" Value="Cascadia Code"/>
                                        <Setter Property="FontSize"   Value="14"/>
                                        <Setter Property="Foreground" Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="Background" Value="Transparent"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                            <Style TargetType="Span">
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="CodeSpan">
                                        <Setter Property="FontFamily" Value="Cascadia Code"/>
                                        <Setter Property="FontSize"   Value="14"/>
                                        <Setter Property="Foreground" Value="{Binding ElementName=OpenAsMdButton, Path=Foreground}" />
                                        <Setter Property="Background" Value="Transparent"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>

                            <Style TargetType="Hyperlink">
                                <Setter Property="TextDecorations" Value="None" />
                            </Style>

                            <Style TargetType="Image">
                                <Setter Property="RenderOptions.BitmapScalingMode"
                                Value="NearestNeighbor" />
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="imageright">
                                        <Setter Property="Margin"  Value="20,0,0,0" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>

                            <!--
                        The Table's style don't seem to support border-collapse.
                        By making the ruled line width 0.5 and applying it to cell and table,
                        it looks like the ruled lines are not doubled.
                        -->
                            <Style TargetType="Table">
                                <Setter Property="CellSpacing" Value="0"/>
                                <Setter Property="BorderThickness" Value="0.5"/>
                                <Setter Property="BorderBrush" Value="Gray"/>
                            </Style>

                            <Style TargetType="TableRowGroup">
                                <Style.Triggers>
                                    <Trigger Property="Tag" Value="TableHeader">
                                        <Setter Property="FontWeight" Value="DemiBold"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>

                            <Style TargetType="TableCell">
                                <Setter Property="BorderThickness" Value="0.5"/>
                                <Setter Property="BorderBrush" Value="Gray"/>
                                <Setter Property="Padding" Value="2"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type TableRow}}, Path=Tag}" Value="EvenTableRow">
                                        <Setter Property="Background" Value="Transparent"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>

                            <Style TargetType="BlockUIContainer">
                                <Style.Triggers>
                                    <Trigger Property="Tag"  Value="RuleSingle">
                                        <Setter Property="Margin" Value="0,3"/>
                                    </Trigger>

                                    <Trigger Property="Tag"  Value="RuleDouble">
                                        <Setter Property="Margin" Value="0,3"/>
                                    </Trigger>

                                    <Trigger Property="Tag"  Value="RuleBold">
                                        <Setter Property="Margin" Value="0,3"/>
                                    </Trigger>

                                    <Trigger Property="Tag"  Value="RuleBoldWithSingle">
                                        <Setter Property="Margin" Value="0,3"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Style.Resources>
                    </Style>
                </mdxaml:MarkdownScrollViewer.MarkdownStyle>
            </mdxaml:MarkdownScrollViewer>

            <GridSplitter
                Grid.Row="1"
                ResizeDirection="Rows"
                Height="2"
                VerticalAlignment="Center"
                HorizontalAlignment="Stretch"
                />

            <TextBox
                Grid.Row="2"
                VerticalAlignment="Stretch"
                IsEnabled="{Binding IsEnabledPrompt, Mode=OneWay}"
                Text="{Binding PromptText, UpdateSourceTrigger=PropertyChanged}"
                FontSize="18"
                AcceptsReturn="True"
                >
                <TextBox.InputBindings>
                    <KeyBinding Command="{Binding Path=CreatePromptCommand}" Key="Enter" />
                </TextBox.InputBindings>
            </TextBox>

        </Grid>


    </Grid>
</UserControl>
